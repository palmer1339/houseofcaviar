
(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event,Layout=YAHOO.widget.Layout,Button=YAHOO.widget.Button,Lang=YAHOO.lang,Connect=YAHOO.util.Connect,LOGIN='/secure/login.bml',fileFilters={'Audio':['aac','aif','aifc','aiff','flac','m3u','mid','midi','mpa','mp3','ra','ram','wav','wave','wma'],'Compressed Files':['7z','ace','bz','bz2','bzip','bzip2','gz','tar','rar','taz','tgz','zip'],'Flash Movies':['fla','flv','swf'],'Fonts':['fnt','fon','otf','ttf'],'HTML/CSS':['css','htm','html','shtm','shtml','xht','xhtml'],'Images':['bmp','dwf','gif','ico','jpg','jpeg','png','psd','psp','svg','tif','tiff'],'MS Access':['accdb','accde','accdt','accdr','mdb'],'MS Excel':['xlam','xls','xlt','xlsb','xlsx','xlsm','xltx','xltm'],'MS PowerPoint':['ppam','ppt','pps','ppsx','ppsm','pptx','pptm','pot','potm','potx'],'MS Word':['doc','docm','docx','dot','dotm','dotx'],'OpenOffice':['odb','odc','odf','odg','odi','odm','odp','ods','odt','otc','otf','otg','oth','oti','otp','ots','ott'],'PDFs':['pdf'],'Text':['conf','config','csv','dat','ini','log','rtf','txt'],'Scripts':['asa','asax','asp','aspx','cfm','cgi','inc','js','php','php3','php4','php5','phtm','phtml','pl','pm','py','sql'],'System Files':['htaccess','htpasswd'],'Video':['3gp','asf','avi','mpg','mpeg','mov','mp4','qt','rm','wmv'],'XML':['xml','xsl','xslt']},validBasename=function(f){if(f.indexOf('.')>-1){if(f.substr(0,f.lastIndexOf('.')).match(/^[a-z0-9@\.:_+\/ -]+$/i)){return true;}else{return false;}}else{if(f.match(/^[a-z0-9@\.:_+ -]+$/i)){return true;}else{return false;}}},validFilename=function(f){var ext=f.substr(f.lastIndexOf('.')+1).toLowerCase();for(var o in fileFilters){for(var i=0,len=fileFilters[o].length;i<len;i++){if(ext===fileFilters[o][i]){return validBasename(f);}}}
return false;},editTypes=function(){var O={},T=[].concat(fileFilters['HTML/CSS'],fileFilters['Text'],fileFilters['Scripts'],fileFilters['System Files'],fileFilters['XML']);for(var i=0,len=T.length;i<len;i++){O[T[i]]=true;}
return O;}(),previewTypes=function(){var O={},T=[].concat(fileFilters['Audio'],fileFilters['Flash Movies'],fileFilters['Images'],fileFilters['Video']);for(var i=0,len=T.length;i<len;i++){O[T[i]]=true;}
O.htaccess=false;O.htpasswd=false;return Lang.merge(editTypes,O);}(),byteUnits={Gb:1073741824,Mb:1048576,Kb:1024,b:0},byteHumanize=function(size){for(var k in byteUnits){if(size>=byteUnits[k]){return YAHOO.util.Number.format(byteUnits[k]!==0?size/byteUnits[k]:size,{decimalPlaces:(byteUnits[k]===0?0:2),suffix:k});}}},symbolicPerms=function(mode_n){mode_n=parseInt(mode_n,8);var perms=[],flags=['x','w','r'];for(var i=0;i<=8;i++){perms.unshift(mode_n&1?flags[i%3]:'-');mode_n=mode_n>>1;}
return perms.join('');},tinymce_config={theme:'modern',visual:false,convert_urls:false,relative_urls:false,theme_advanced_toolbar_location:'top',theme_advanced_toolbar_align:'left',theme_advanced_statusbar_location:'bottom',plugins:'advlist,anchor,autolink,autosave,charmap,code,contextmenu,directionality,emoticons,fullpage,fullscreen,hr,image,insertdatetime,link,lists,media,nonbreaking,pagebreak,paste,preview,print,table,textcolor,save,searchreplace,visualblocks,visualchars,wordcount',toolbar1:"undo redo unlink forecolor backcolor emoticons bold italic underline fontsizeselect",toolbar2:"preview alignleft aligncenter alignright alignjustify bullist numlist indent outdent fontselect"},treeview,layout,xhrdatasource,filterdatasource,datatable,file_toolbar,folder_toolbar;window.validFilename=validFilename;YAHOO.widget.Uploader.SWFURL='/generalAppC/javascripts/yui/uploader/assets/uploader.swf';(function(){var _embedSWF=YAHOO.widget.Uploader.superclass._embedSWF;YAHOO.widget.Uploader.superclass._embedSWF=function(){arguments[5]='/generalAppC/javascripts/expressinstall.swf';_embedSWF.apply(this,arguments);};})();Connect.completeEvent.subscribe(function(type,args){var o=args[0];if((o.conn.status>=301&&o.conn.status<304)||o.conn.status===307||o.conn.status===0){var domain=location.hostname.split('.').splice(1).join('.');document.cookie='request_uri='+location.href+'; path=/; domain=.'+domain;window.location=LOGIN;}else if(o.conn.status>=500&&o.conn.status<600){StatusBar.set({type:'error',msg:'Internal Server Error. Please try again.'});}else{try{var json=Lang.JSON.parse(o.conn.getResponseHeader('X-JSON'));if(json.status){StatusBar.set(json.status);}}catch(E){}}});Connect.abortEvent.subscribe(function(type,args){var o=args[0];if(xhrdatasource._oQueue.conn.conn!==o.conn){StatusBar.set({type:'error',msg:'Action aborted'});}});(function(){var runners=0,_statusEvent=function(type,args){var status=Dom.get('act_throbber');if(type=='start'){runners++;if(status){Dom.setStyle(status,'display','');}}else if(type=='complete'||type=='abort'){runners--;if(status&&runners<=0){Dom.setStyle(status,'display','none');}}
runners=runners<0?0:runners;};Connect.startEvent.subscribe(_statusEvent);Connect.completeEvent.subscribe(_statusEvent);Connect.abortEvent.subscribe(_statusEvent);})();if(!YAHOO.widget.DataTable.prototype.selectAllRows){YAHOO.widget.DataTable.prototype._selectAllTrEls=function(){Dom.getElementsByClassName(YAHOO.widget.DataTable.CLASS_EVEN,"tr",this._elTbody,function(el){Dom.addClass(el,YAHOO.widget.DataTable.CLASS_SELECTED)});Dom.getElementsByClassName(YAHOO.widget.DataTable.CLASS_ODD,"tr",this._elTbody,function(el){Dom.addClass(el,YAHOO.widget.DataTable.CLASS_SELECTED)});};YAHOO.widget.DataTable.prototype.selectAllRows=function(){var tracker=this._aSelections||[];for(var j=tracker.length-1;j>-1;j--){if(YAHOO.lang.isString(tracker[j])){tracker.splice(j,1);}}
this._aSelections=tracker;this._selectAllTrEls();var oSelf=this;setTimeout(function(){Dom.getElementsByClassName(YAHOO.widget.DataTable.CLASS_SELECTED,"tr",oSelf._elTbody,function(el){oSelf.selectRow(el);},oSelf,true);},0);};}
YAHOO.widget.PermissionEditor=function(oConfigs){YAHOO.widget.PermissionEditor.superclass.constructor.call(this,'permission',oConfigs);};Lang.extend(YAHOO.widget.PermissionEditor,YAHOO.widget.BaseCellEditor,{checkboxes:[],renderForm:function(){var elDiv=this.getContainerEl().appendChild(document.createElement('div'));elDiv.innerHTML=['<table>','<tbody>','<tr>','<td>&nbsp;</td><th>R</th><th>W</th><th>X</th>','</tr>','<tr>','<th>User</th>','<td><input type="checkbox" value="400" name="u_r" /></td>','<td><input type="checkbox" value="200" name="u_w" /></td>','<td><input type="checkbox" value="100" name="u_x" /></td>','</tr>','<tr>','<th>Group</th>','<td><input type="checkbox" value="40" name="g_r" /></td>','<td><input type="checkbox" value="20" name="g_w" /></td>','<td><input type="checkbox" value="10" name="g_x" /></td>','</tr>','<tr>','<th>Other</th>','<td><input type="checkbox" value="4" name="o_r" /></td>','<td><input type="checkbox" value="2" name="o_w" /></td>','<td><input type="checkbox" value="1" name="o_x" /></td>','</tr>','<tr>','<td>&nbsp;</td>','<td colspan="2"><input type="text" name="mode_n" value="" size="5" maxlength="3" /></td>','<td>&nbsp;</td>','</tr>','</tbody>','</table>'].join('');this.checkboxes=Dom.getElementsBy(function(el){return el.type==='checkbox'},'input',elDiv);this.mode_n=Dom.getElementBy(function(el){return(el.type==='text'&&el.name==='mode_n')},'input',elDiv);var oSelf=this;Event.on(this.checkboxes,'click',function(e){oSelf.mode_n.value=oSelf.getInputValue();});Event.on(this.mode_n,'keyup',function(e){this.value=this.value.replace(/[^0-7]/g,'');oSelf.value=this.value;oSelf.resetForm();});if(this.disableBtns){this.handleDisabledBtns();}},resetForm:function(){var perm=parseInt(this.value,10)||0;this.mode_n.value=perm;if(perm<1){Dom.batch(this.checkboxes,function(el){el.checked=false;});return;}
for(var i=0,len=this.checkboxes.length;i<len;i++){var c=this.checkboxes[i];c.checked=false;if((perm%parseInt(c.value,10))!==perm){c.checked=true;}
perm=perm%parseInt(c.value,10);}},focus:function(){this.mode_n.focus();},getInputValue:function(){var perm=0;for(var i=0,len=this.checkboxes.length;i<len;i++){if(this.checkboxes[i].checked){perm=perm+parseInt(this.checkboxes[i].value,10);}}
perm=perm+'';if(perm.length<3){for(var i=0;i<perm.length-3;i++){perm='0'+perm;}}
return perm;}});Lang.augmentObject(YAHOO.widget.PermissionEditor,YAHOO.widget.BaseCellEditor);YAHOO.widget.FolderNode=function(oData,oParent,expanded){YAHOO.widget.FolderNode.superclass.constructor.call(this,oData,oParent,expanded);};YAHOO.extend(YAHOO.widget.FolderNode,YAHOO.widget.TextNode,{saveEditorValue:function(editorData){var node=editorData.node,value=editorData.inputElement.value,old_value=node.label;YAHOO.widget.FolderNode.superclass.saveEditorValue.call(this,editorData);this.tree.fireEvent('editorSaveEvent',{node:node,prevValue:old_value,newValue:value});}});var _buildAppLayout=function(){var oSelf=this;layout=new Layout('layout',{height:this.get('appHeight'),units:[{position:'left',body:'fldr_pane',width:this.get('folderPaneWidth'),minWidth:this.get('folderPaneMinWidth'),maxWidth:this.get('folderPaneMaxWidth'),resize:true,scroll:null,gutter:'0 5px 0 0'},{position:'center',body:'file_pane',scroll:false}]});layout.on('resize',function(){var sizes=this.getSizes();if(datatable){datatable.set('width',(sizes.center.w-oSelf.get('fileTableWidthOffset'))+'px');datatable.setColumnWidth(datatable.getColumn('name'),sizes.center.w-oSelf.get('fileTableColumnOffset'));}});Event.on(window,'resize',layout.resize,layout,true);layout.render();};var _buildFolderTreeview=function(){var oSelf=this;treeview=new YAHOO.widget.TreeView('fldr_trvw',{type:'FolderNode',label:'root',labelStyle:'icon-root',isDocRoot:true,title:'DocumentRoot',path:this.get('rootFolder'),editable:false,expanded:true});treeview.createEvent('editorSaveEvent',treeview);treeview.subscribe('editorSaveEvent',function(o){Connect.asyncRequest('GET',oSelf.M_BASE('renamedir',{dir:o.node.parent.data.path,old_v:o.prevValue,new_v:o.newValue}),{success:function(r){o.node.data.path=Lang.trim(r.responseText);o.node.data.path_e=o.node.getLabelEl().innerHTML;treeview.removeChildren(o.node);xhrdatasource.flushCache();oSelf.set('currentFolder',o.node.data.path);}});});treeview.subscribe('focusChanged',function(o){if(o.newNode){Dom.getElementsByClassName('current',undefined,'fldr_trvw',function(el){Dom.removeClass(el,'current');});Dom.addClass(o.newNode.getContentEl(),'current');oSelf.set('currentFolder',o.newNode.data.path);}});treeview.subscribe('dblClickEvent',treeview.onEventEditNode);var focus=function(o){var node=o.focus?o:o.node;node.focus();};treeview.subscribe('clickEvent',focus);treeview.subscribe('expand',focus);var loadNodeData=function(node,fn){Connect.asyncRequest('GET',oSelf.M_BASE('dirlist',{p:node.data.path}),{success:function(o){try{var data=Lang.JSON.parse(o.responseText);for(var i=0,len=data.length;i<len;i++){var d=data[i];d.label=YAHOO.util.DataSource.parseString(d.label);d.path=YAHOO.util.DataSource.parseString(d.path);if(d.isDocRoot){var root=treeview.getRoot().children[0];if(root.data.isDocRoot){Dom.replaceClass(root.getLabelEl(),root.labelStyle,root.labelStyle='ygtvlabel');root.getLabelEl().title=''
root.data.isDocRoot=false;root.title='';}
d.labelStyle='icon-root';d.title='DocumentRoot';}
new YAHOO.widget.FolderNode(d,node,false);}}catch(E){}
fn();}});};treeview.setDynamicLoad(loadNodeData);treeview.render();};var _buildFileTable=function(){var oSelf=this,USE_TIME_AGE=3600*24*182*1000,sizeFormatter=function(el,r,c,d){el.innerHTML=r.getData('is_folder')?d+' items':byteHumanize(d);},dateFormatter=function(el,r,c,d){var format=(((new Date).getTime()-d.getTime())>USE_TIME_AGE)?oSelf.get('oldDateFormat'):oSelf.get('dateFormat');el.innerHTML=YAHOO.util.Date.format(d,{format:format},'en');el.title=YAHOO.util.Date.format(d,{format:oSelf.get('fullDateFormat')});},modeFormatter=function(el,r,c,d){el.innerHTML=d;el.title=r.getData('mode_s');},typeFormatter=function(el,r,c,d){if(d){el.innerHTML='<div class="img icon-'+d+'"></div>';if(d==='-folder'){Dom.setAttribute(Dom.getFirstChild(el),'title','Double-Click to open');}}else{el.innerHTML='<div class="img"></div>';}},nameFormatter=function(el,r,c,d){el.innerHTML='<span style="white-space:nowrap">'+d+'</span>';setTimeout(function(){var span=el.firstChild,width=parseInt(Dom.getStyle(el,'width'),10);if(span.offsetWidth>width){var i=1;span.innerHTML='';while(span.offsetWidth<width&&i<d.length){span.innerHTML=d.substr(0,i++)+'...';}
el.innerHTML=span.innerHTML;el.title=d;}else{el.innerHTML=d;}},0);},createActionButtons=function(el,r,c,d){var a=[],v=r.getData('versions');if(!r.getData('is_folder')){if(editTypes[r.getData('type')]){a[a.length]='<input type="image" src="/images/blank.gif" class="edit" title="Edit" value="" />';}else{a[a.length]='<div class="edit"></div>';}}else{if(oSelf.get('folderOpenAction')){a[a.length]='<input type="image" src="/images/blank.gif" class="open" title="Open Directory" value="" />';}else{a[a.length]='<div></div>';}}
if(!oSelf.get('currentConnection')){if(r.getData('uri')&&(previewTypes[r.getData('type')]||r.getData('is_folder'))){a[a.length]='<input type="image" src="/images/blank.gif" class="preview" title="Preview" value="" />';}else{a[a.length]='<div class="preview"></div>';}}else{a[a.length]='<div></div>';}
if(!r.getData('is_folder')){a[a.length]='<input type="image" src="/images/blank.gif" class="download" title="Download" value="" />';}
if(!r.getData('is_folder')&&Lang.isArray(v)){if(v.length>0&&editTypes[r.getData('type')]){a[a.length]='<input type="image" src="/images/blank.gif" class="version" title="Versions" value="" />';}else{a[a.length]='<div class="version"></div>';}}else{a[a.length]='<div></div>';}
el.innerHTML=a.join('');},handleFileRename=function(fn,value){var record=this.getRecord();if(!(record.getData('is_folder')?validBasename(value):validFilename(value))){StatusBar.set({type:'error',msg:'Invalid filename.',time:5000});fn(false,value);return;}
var res=oSelf.get('currentResponse').results;for(var i=0,len=res.length;i<len;i++){if(res[i].name===value){StatusBar.set({type:'error',msg:'File already exists.',time:5000});fn(false,value);return;}}
Connect.asyncRequest('GET',oSelf.M_BASE(record.getData('is_folder')?'renamedir':'renamefile',{dir:oSelf.get('currentFolder'),old_v:record.getData('name'),new_v:value}),{success:function(o){oSelf.reloadFileTable(true);if(record.getData('is_folder')){var node=treeview.getNodeByProperty('path',oSelf.get('currentFolder'));if(node){treeview.removeChildren(node);}}}});fn(true,value);},handlePermissionChange=function(fn,value){var record=this.getRecord();if(record.getData('is_folder')?((parseInt(value,8)>>6)&05)==05:((parseInt(value,8)>>6)&04)==04){Connect.asyncRequest('GET',oSelf.M_BASE('chmod',{file:record.getData('path'),mode_n:value}),{success:function(o){oSelf.reloadFileTable(true);if(record.getData('is_folder')&&treeview.getNodeByProperty(record.getData('path'))){oSelf.refreshFolderView();}}});fn(true,value);}else{if(record.getData('is_folder')){StatusBar.set({type:'error',msg:'Must have at least read and execute access for the user.'});}else{StatusBar.set({type:'error',msg:'Must have at least read access for the user.'});}
fn(false,value);}},sortFieldFunc=function(field,a,b,desc){var sorted=YAHOO.util.Sort.compare(a.getData(field),b.getData(field),desc);if(sorted===0){return YAHOO.util.Sort.compare(a.getCount(),b.getCount(),desc);}else{return sorted;}},fileFolderSort=function(field,a,b,desc){if(a.getData('is_folder')&&b.getData('is_folder')){return sortFieldFunc(field,a,b,desc);}else if(a.getData('is_folder')){return-1;}else if(b.getData('is_folder')){return 1;}else{return sortFieldFunc(field,a,b,desc);}},nameSort=function(a,b,desc){return fileFolderSort('name',a,b,desc);},sizeSort=function(a,b,desc){return fileFolderSort('size',a,b,desc);},mtimeSort=function(a,b,desc){return fileFolderSort('mtime',a,b,desc);},typeSort=function(a,b,desc){return fileFolderSort('type',a,b,desc);};filterdatasource=new YAHOO.util.FunctionDataSource(function(q){q=q||{};var filtered=[],curr=oSelf.get('currentResponse');if(!Lang.isString(q.search)&&!Lang.isString(q.filter)&&!Lang.isBoolean(q.showSys)){return curr.results;}
var qre=new RegExp('^('+q.filter+')$','i');for(var i=0,len=curr.results.length;i<len;i++){var r=curr.results[i];if(!q.showSys&&r.name.substr(0,1)==='.'){continue;}
if(q.search&&r.name.toLowerCase().substr(0,q.search.length)!==q.search.toLowerCase()){continue;}
if(q.filter&&!qre.exec(r.type)){continue;}
filtered[filtered.length]=r;}
return filtered;},{responseType:YAHOO.util.FunctionDataSource.TYPE_JSARRAY});xhrdatasource=new YAHOO.util.XHRDataSource(this.M_BASE('filelist'),{responseType:YAHOO.util.XHRDataSource.TYPE_JSARRAY,responseSchema:{fields:[{key:'type',parser:'string'},{key:'name',parser:'string'},{key:'size',parser:'number'},{key:'mtime',parser:'date'},{key:'mode_n',parser:'number'},{key:'mode_s',parser:'string'},{key:'path',parser:'string'},{key:'uri',parser:'string'},{key:'is_folder'},{key:'versions'}]},maxCacheEntries:8,connXhrMode:'cancelStaleRequests'});datatable=new YAHOO.widget.ScrollingDataTable('file_tble',[{key:'select',label:'<input type="checkbox" title="Select/Deselect All" />',width:10,formatter:YAHOO.widget.DataTable.formatCheckbox},{key:'type',label:'&nbsp;',width:16,formatter:typeFormatter,sortable:true,sortOptions:{sortFunction:typeSort}},{key:'name',label:'Name',width:(layout.getSizes().center.w-this.get('fileTableColumnOffset')),editor:new YAHOO.widget.TextboxCellEditor({asyncSubmitter:handleFileRename}),formatter:nameFormatter,sortable:true,sortOptions:{sortFunction:nameSort}},{key:'size',label:'Size',formatter:sizeFormatter,width:60,sortable:true,sortOptions:{sortFunction:sizeSort}},{key:'mtime',label:'Modified',width:105,formatter:dateFormatter,sortable:true,sortOptions:{sortFunction:mtimeSort}},{key:'mode_n',label:'<abbr title="Permissions">Perm.</abbr>',width:30,formatter:modeFormatter,editor:new YAHOO.widget.PermissionEditor({asyncSubmitter:handlePermissionChange})},{key:'actions',label:'Actions',width:72,formatter:createActionButtons}],filterdatasource,{initialLoad:false,renderLoopSize:0,MSG_EMPTY:'No Files.',sortedBy:{key:'name',dir:YAHOO.widget.DataTable.CLASS_ASC},width:(layout.getSizes().center.w-this.get('fileTableWidthOffset'))+'px',height:(layout.getSizes().center.h-this.get('fileTableHeightOffset'))+'px'});this.on('currentResponseChange',this.sendFilterRequest);xhrdatasource.subscribe('responseParseEvent',function(o){oSelf.set('currentResponse',o.response);});xhrdatasource.subscribe('cacheResponseEvent',function(o){oSelf.set('currentResponse',o.response);});filterdatasource.subscribe('responseParseEvent',function(o){datatable.unselectAllRows();});xhrdatasource.sendRequest('&p='+encodeURIComponent(this.get('rootFolder')));datatable.subscribe('theadCheckboxClickEvent',function(e){if(e.target.checked){datatable.selectAllRows();}else{datatable.unselectAllRows();}
return false;});datatable.subscribe('unselectAllRowsEvent',function(o){for(var i=0,len=o.records.length;i<len;i++){var row=datatable.getTrEl(o.records[i]);datatable.fireEvent('rowUnselectEvent',{el:row});}
datatable.getColumn('select').getThLinerEl().firstChild.firstChild.checked=false;return false;});datatable.subscribe('rowClickEvent',datatable.onEventSelectRow);datatable.subscribe('checkboxClickEvent',function(e){var fakeEvent={ctrlKey:e.event.ctrlKey,metaKey:e.event.metaKey,shiftKey:e.event.shiftKey};if(navigator.userAgent.toLowerCase().indexOf('mac')!=-1){if(!fakeEvent.shiftKey&&!fakeEvent.metaKey){fakeEvent.metaKey=true;}}else{if(!fakeEvent.shiftKey&&!fakeEvent.ctrlKey){fakeEvent.ctrlKey=true;}}
e.event=fakeEvent;datatable.onEventSelectRow(e);return false;});var rowSelectionManager=function(e,bool){var input=Dom.getElementsBy(function(el){return(el.type.toLowerCase()==='checkbox'&&(bool?!el.checked:el.checked));},'input',e.el,function(el){el.checked=bool;});};datatable.subscribe('rowSelectEvent',rowSelectionManager,true);datatable.subscribe('rowUnselectEvent',rowSelectionManager,false);datatable.onEventShowCellEditor=function(oArgs){var elCell=this.getTdEl(oArgs.target);var oRecord=this.getRecord(elCell);var oColumn=this.getColumn(elCell);if(oColumn.getField()==='type'&&oRecord.getData('is_folder')){treeview.getNodeByProperty('path',oSelf.get('currentFolder')).expand();treeview.getNodeByProperty('path',oRecord.getData('path')).expand();oSelf.set('currentFolder',oRecord.getData('path'));}else{this.showCellEditor(elCell,oRecord,oColumn);}};datatable.subscribe('cellDblclickEvent',datatable.onEventShowCellEditor);datatable.subscribe('buttonClickEvent',function(e){var el=e.target,r=datatable.getRecord(el),className=Dom.getAttribute(el,'class');switch(className){case'open':treeview.getNodeByProperty('path',oSelf.get('currentFolder')).expand();treeview.getNodeByProperty('path',r.getData('path')).expand();oSelf.set('currentFolder',r.getData('path'));break;case'edit':if(r.getData('type').match(/^(s|x)?ht(ml?)?$/)&&oSelf.richEditEl.checked&&!oSelf.get('currentConnection')){oSelf.richEdit(r);}else{oSelf.simpleEdit(r);}
break;case'version':oSelf.showVersions(r);break;case'preview':window.open(r.getData('uri'));break;case'download':window.open(oSelf.M_BASE('dlfile',{p:r.getData('path')}));break;default:return true;}
return false;});this.on('beforeCurrentFolderChange',function(o){return!(o.prevValue===o.newValue);});this.on('currentFolderChange',function(o){oSelf.reloadFileTable(false)});};var _buildToolbarButtons=function(){var oSelf=this;folder_toolbar=new YAHOO.widget.Toolbar('fldr_tlbr',{buttonType:'advanced',buttons:[{group:'folders',buttons:[{id:'fldr_new',type:'push',label:'New Directory',value:'new'},{id:'fldr_delete',type:'push',label:'Delete Directory',value:'delete',disabled:true},{id:'fldr_permissions',type:'push',label:'Directory Permissions',value:'permissions',disabled:true},{id:'fldr_refresh',type:'push',label:'Refresh',value:'refresh'}]}]});file_toolbar=new YAHOO.widget.Toolbar('file_tlbr',{buttonType:'advanced',buttons:[{group:'new_content',buttons:[{id:'file_upload',type:'push',label:'Upload Files',value:'upload'},{id:'file_new',type:'push',label:'New File',value:'new'},{id:'file_refresh',type:'push',label:'Refresh',value:'refresh'}]},{group:'bulk_modify',buttons:[{id:'file_copy',type:'push',label:'Copy',value:'copy',disabled:this.get('bulkButtonsDisabled')},{id:'file_move',type:'push',label:'Move',value:'move',disabled:this.get('bulkButtonsDisabled')},{id:'file_archive',type:'push',label:'Archive',value:'archive',disabled:this.get('bulkButtonsDisabled')},{id:'file_permissions',type:'push',label:'Permissions',value:'permissions',disabled:this.get('bulkButtonsDisabled')}]},{group:'deletion',buttons:[{id:'file_delete',type:'push',label:'Delete',value:'delete',disabled:this.get('bulkButtonsDisabled')}]}]});var aRecords=[];var map={fldr_new:function(o){oSelf.createFolder();},fldr_delete:function(o){oSelf.deleteFolder();},fldr_refresh:function(o){oSelf.refreshFolderView();},fldr_permissions:function(o){oSelf.changeFolderPermissions();},file_upload:function(o){oSelf.uploadFile();},file_new:function(o){oSelf.createFile();},file_refresh:function(o){oSelf.reloadFileTable(true);},file_copy:function(o){oSelf.copyFiles(aRecords);},file_move:function(o){oSelf.moveFiles(aRecords);},file_archive:function(o){oSelf.archiveFiles(aRecords);},file_permissions:function(o){oSelf.changeFilePermissions(aRecords);},file_delete:function(o){oSelf.deleteFiles(aRecords);}};var dispatch=function(o){var fn=map[o.button.id],rsIDs=datatable.getSelectedRows(),i,len;for(i=0,len=rsIDs.length;i<len;i++){aRecords.push(datatable.getRecord(rsIDs[i]));}
if(fn){fn.call(this,o);}
aRecords=[];return false;};this.on('currentFolderChange',function(o){if(o.newValue===this.get('rootFolder')){folder_toolbar.disableButton('fldr_delete');folder_toolbar.disableButton('fldr_permissions');}else{var node=treeview.getNodeByProperty('path',o.newValue);if(node&&node.data.isDocRoot){folder_toolbar.disableButton('fldr_delete');folder_toolbar.disableButton('fldr_permissions');}else{folder_toolbar.enableButton('fldr_delete');folder_toolbar.enableButton('fldr_permissions');}}});file_toolbar.on('buttonClick',dispatch,undefined,this);folder_toolbar.on('buttonClick',dispatch,undefined,this);var toggleButtons=function(e){var recs=this.getSelectedRows();oSelf.set('bulkButtonsDisabled',recs.length>0?false:true);};datatable.subscribe('rowSelectEvent',toggleButtons);datatable.subscribe('rowUnselectEvent',toggleButtons);};var _buildFilterBar=function(){var oSelf=this;(function(){var lastValue='',el=Dom.get('file_srch_box');var onInterval=function(){var currValue=el.value;if(currValue!==lastValue){lastValue=currValue;oSelf.sendFilterRequest({search:currValue});}};Lang.later(500,oSelf,onInterval,undefined,true);Event.on(Dom.getNextSibling(el),'click',function(){el.value='';});})();(function(){var el=Dom.get('file_srch_fltr'),arr=[{text:'All Files',value:''}];for(var k in fileFilters){arr[arr.length]={text:k,value:fileFilters[k].join('|')};}
var menu=new YAHOO.widget.Button({type:'menu',label:arr[0].text,container:'file_srch_fltr2',menu:arr});menu.getMenu().subscribe('click',function(sType,aArgs){var item=aArgs[1];menu.set('label',item.cfg.getProperty('text'));el.value=item.value;oSelf.sendFilterRequest({filter:item.value});});})();if(this.get('haveFTP')){(function(){var button=new YAHOO.widget.Button({type:'menu',label:'<em>Local Filesystem</em>',container:'fldr_ftp',menu:[{text:'<em>Local Filesystem</em>',value:''}],lazyloadmenu:false});button.getMenu().subscribe('click',function(sType,aArgs){var item=aArgs[1];button.set('label',item.cfg.getProperty('text'));oSelf.set('currentConnection',item.value);});oSelf.set('connButton',button);})();}};var _initSettings=function(){this.sysFilesEl=Dom.get('file_srch_sys');this.richEditEl=Dom.get('file_rich_edit');Event.on(this.sysFilesEl,'click',function(){Connect.asyncRequest('GET',this.M_BASE('prefs',{showSys:this.sysFilesEl.checked.toString()}),{success:function(o){StatusBar.set({type:'success',msg:'System file display setting changed.',time:5000});}});this.sendFilterRequest({showSys:this.sysFilesEl.checked});},this,true);Event.on(this.richEditEl,'click',function(){Connect.asyncRequest('GET',this.M_BASE('prefs',{richEdit:this.richEditEl.checked.toString()}),{success:function(o){StatusBar.set({type:'success',msg:'HTML editor setting changed.',time:5000});}});},this,true);};YAHOO.widget.FileManager=function(config){YAHOO.widget.FileManager.superclass.constructor.call(this);config=Lang.isObject(config)?config:{};this.initAttributes(config);this.postInit();};Lang.extend(YAHOO.widget.FileManager,YAHOO.util.AttributeProvider,{init:function(config){_buildAppLayout.call(this);_buildFolderTreeview.call(this);_buildFileTable.call(this);_buildFilterBar.call(this);_buildToolbarButtons.call(this);_initSettings.call(this);},postInit:function(){this.refresh('isWindows');},M_BASE:function(cmd,o){var base='/controlpanel/FileManager/m.cmp?cmd='+cmd,uri=base,pairs=[base];if(this.get('haveFTP')&&this.get('currentConnection')){o=o||{};o.conn=this.get('currentConnection');}
if(o&&Lang.isObject(o)){for(var k in o){pairs.push(encodeURIComponent(k)+'='+encodeURIComponent(o[k]));}
uri=pairs.join('&');}
return uri;},initAttributes:function(config){this.setAttributeConfig('appHeight',{value:config.appHeight||500,validator:Lang.isNumber});this.setAttributeConfig('folderPaneWidth',{value:config.folderPaneWidth||200,validator:Lang.isNumber});this.setAttributeConfig('folderPaneMinWidth',{value:config.folderPaneMinWidth||200,validator:Lang.isNumber});this.setAttributeConfig('folderPaneMaxWidth',{value:config.folderPaneMaxWidth||370,validator:Lang.isNumber});this.setAttributeConfig('dateFormat',{value:config.dateFormat||'%b %e %l:%M %p',validator:Lang.isString});this.setAttributeConfig('oldDateFormat',{value:config.oldDateFormat||'%b %e %Y',validator:Lang.isString});this.setAttributeConfig('fullDateFormat',{value:config.fullDateFormat||'%b %e, %Y %l:%M:%S %p',validator:Lang.isString});this.setAttributeConfig('currentResponse',{value:{},validator:Lang.isObject,method:function(value){if(value&&value.results){datatable.set('renderLoopSize',value.results.length>100?100:0);}}});this.setAttributeConfig('fileTableWidthOffset',{value:1,readOnly:true});this.setAttributeConfig('fileTableHeightOffset',{value:(YAHOO.env.ua.ie?108:104),readOnly:true});this.setAttributeConfig('fileTableColumnOffset',{value:434,readOnly:false});this.on('fileTableColumnOffsetChange',function(){var l=this.get('managerLayout');l.resize();});this.setAttributeConfig('haveFTP',{value:(Dom.get('ftp_connections')?true:false),readOnly:true});this.setAttributeConfig('connButton',{value:null,writeOnce:true,validator:function(){return this.get('haveFTP')}});this.setAttributeConfig('connList',{value:null,validator:function(){return this.get('haveFTP')},method:function(value){if(value&&value.length){var btn=this.get('connButton');if(btn){var m=btn.getMenu();m.clearContent();m.addItem({text:'<em>Local Filesystem</em>',value:''});for(var i=0,len=value.length;i<len;i++){m.addItem({text:'<em>'+value[i].label+'</em>',value:value[i].id});}
m.render();}}}});this.setAttributeConfig('currentConnection',{validator:function(value){return this.get('haveFTP');}});this.on('currentConnectionChange',function(o){xhrdatasource.liveData=this.M_BASE('filelist');var value=o.newValue;if(value){this.set('isWindows',false);this.set('rootFolder','');if(!this.set('currentFolder','')){this.refreshFolderView();}
this.reloadFileTable(true);}else{this.resetValue('isWindows');this.resetValue('rootFolder');if(!this.set('currentFolder','')){this.refreshFolderView();}
this.reloadFileTable(true);}});this.refreshConnections();this.setAttributeConfig('haveTemplates',{value:(Dom.get('templates')?true:false),readOnly:true});this.refreshTemplates();this.setAttributeConfig('rootFolder',{value:config.rootFolder||'',readOnly:false});this.setAttributeConfig('currentFolder',{value:this.get('rootFolder'),validator:Lang.isString,method:function(value){Dom.get('file_srch_box').value='';var root=this.get('rootFolder'),node=treeview.getNodeByProperty('path',value),path=node.data.path_e||value;if(root.length>0){Dom.get('file_path').innerHTML=path.substr(root.length);}else{Dom.get('file_path').innerHTML='/'+path;}}});this.setAttributeConfig('winFuncsStylesheet',{value:YAHOO.util.StyleSheet().disable().set('#fldr_permissions, #file_permissions, #file_srch_sys2',{display:'none'})});this.setAttributeConfig('isWindows',{value:config.isWindows||false,validator:Lang.isBoolean,method:function(value){this.toggleModeColumn(!value);if(value){this.get('winFuncsStylesheet').enable();}else{this.get('winFuncsStylesheet').disable();}}});this.setAttributeConfig('bulkButtonsDisabled',{value:true,validator:Lang.isBoolean,method:function(value){var oldValue=this.get('bulkButtonsDisabled');if(oldValue!==value){var btns=['file_copy','file_move','file_delete','file_archive','file_expand','file_permissions'];for(var i=0,len=btns.length;i<len;i++){if(btns[i]==='file_archive'||btns[i]==='file_expand'){if(this.get('haveFTP')&&this.get('currentConnection')){file_toolbar.disableButton(btns[i]);continue;}}
if(value){file_toolbar.disableButton(btns[i]);}else{file_toolbar.enableButton(btns[i]);}}}}});this.init();this.setAttributeConfig('managerLayout',{value:layout,readOnly:true});this.setAttributeConfig('folderTreeview',{value:treeview,readOnly:true});this.setAttributeConfig('fileDataTable',{value:datatable,readOnly:true});this.setAttributeConfig('fileDataSource',{value:xhrdatasource,readOnly:true});this.setAttributeConfig('filterDataSource',{value:filterdatasource,readOnly:true});this.setAttributeConfig('folderToolbar',{value:folder_toolbar,readOnly:true});this.setAttributeConfig('fileToolbar',{value:file_toolbar,readOnly:true});this.setAttributeConfig('uploader',{value:null});this.setAttributeConfig('selectedUploadFiles',{value:[],validator:Lang.isArray});this.setAttributeConfig('uploadPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('createFolderPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('createFilePanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('confirmPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('simpleEditPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('richEditPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('copyMovePanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('permissionPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('versionPanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('archivePanel',{value:null,validator:Lang.isObject});this.setAttributeConfig('folderOpenAction',{value:Lang.isBoolean(config.folderOpenAction)?config.folderOpenAction:false,validator:Lang.isBoolean});},refreshConnections:function(){if(this.get('haveFTP')){Connect.asyncRequest('GET',this.M_BASE('listftp'),{scope:this,success:function(o){try{var json=Lang.JSON.parse(o.responseText);this.set('connList',json);}catch(E){}}});}},refreshTemplates:function(){if(this.get('haveTemplates')){Connect.asyncRequest('GET',this.M_BASE('listtemplates'),{scope:this,success:function(o){try{var data=Lang.JSON.parse(o.responseText);for(var i=0,len=data.length;i<len;i++){data[i].title=data[i].name;data[i].description=data[i].name;data[i].src=location.protocol+'//'+location.host+this.M_BASE('gettemplate',{name:data[i].file});}
tinymce_config.template_templates=data;if(!tinymce_config.theme_advanced_buttons3_add){tinymce_config.plugins=tinymce_config.plugins+',template';tinymce_config.theme_advanced_buttons3_add='|,template';}}catch(E){}}});}},reloadFileTable:function(bFlushCache){datatable.showTableMessage(datatable.get('MSG_LOADING'),YAHOO.widget.DataTable.CLASS_LOADING);datatable.unselectAllRows();if(Lang.isBoolean(bFlushCache)&&bFlushCache){xhrdatasource.flushCache();}
xhrdatasource.sendRequest('&p='+encodeURIComponent(this.get('currentFolder')));},sendFilterRequest:function(o){o=o||{};if(!Lang.isString(o.search)){o.search=Dom.get('file_srch_box').value;}
if(!Lang.isBoolean(o.showSys)){o.showSys=Dom.get('file_srch_sys').checked;}
if(!Lang.isString(o.filter)){o.filter=Dom.get('file_srch_fltr').value;}
filterdatasource.sendRequest(o,{success:datatable.onDataReturnInitializeTable,failure:datatable.onDataReturnInitializeTable,scope:datatable,argument:datatable.getState()});var s=datatable.get('sortedBy');datatable.sortColumn(s.column,s.dir);},getCreateFolderPanel:function(){var panel=this.get('createFolderPanel'),oSelf=this;if(!panel){panel=new YAHOO.widget.Dialog('createFolderPanel',{buttons:[{text:'Save',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.cancel();}}],visible:false,close:true,width:'400px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();Dom.setStyle(panel.innerElement,'display','');panel.callback={success:function(){oSelf.refreshFolderView();}};panel.validate=function(){if(validBasename(this.getData().name)){return true;}else{StatusBar.set({type:'error',msg:'Invalid directory name.',time:5000});return false;}};this.set('createFolderPanel',panel);}
panel.form.elements[0].value='';panel.form.action=this.M_BASE('newdir',{p:this.get('currentFolder')});return panel;},getCreateFilePanel:function(){var panel=this.get('createFilePanel'),oSelf=this;if(!panel){panel=new YAHOO.widget.Dialog('createFilePanel',{buttons:[{text:'Save',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.cancel();}}],visible:false,close:true,width:'400px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();Dom.setStyle(panel.innerElement,'display','');panel.callback={success:function(){oSelf.reloadFileTable(true);}};panel.validate=function(){var fullname=this.getData().name+'.'+this.getData().ext;if(!validFilename(fullname)){StatusBar.set({type:'error',msg:'Invalid filename or extension.',time:5000});return false;}
var res=oSelf.get('currentResponse').results;for(var i=0,len=res.length;i<len;i++){if(res[i].name===fullname){StatusBar.set({type:'error',msg:'File already exists.',time:5000});return false;}}
return true;};var sel=panel.form.ext;for(var k in{'HTML/CSS':true,'Text':true,'Scripts':true,'XML':true}){var og=document.createElement('optgroup');og.label=k;for(var i=0,len=fileFilters[k].length;i<len;i++){var opt=document.createElement('option');opt.value=opt.innerHTML=fileFilters[k][i];og.appendChild(opt);}
sel.appendChild(og);}
this.set('createFilePanel',panel);}
panel.form.elements[0].value='';panel.form.action=this.M_BASE('newfile',{p:this.get('currentFolder')});return panel;},getArchivePanel:function(o){var panel=this.get('archivePanel'),oSelf=this;if(!panel){panel=new YAHOO.widget.Dialog('archivePanel',{buttons:[{text:'Archive',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.cancel();}}],visible:false,close:true,width:'400px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();Dom.setStyle(panel.innerElement,'display','');panel.callback={success:function(){oSelf.reloadFileTable(true);}};panel.validate=function(){var fullname=this.getData().name+'.zip';if(this.getData().name.length<1){StatusBar.set({type:'error',msg:'Invalid archive name.',time:5000});return false;}
var res=oSelf.get('currentResponse').results;for(var i=0,len=res.length;i<len;i++){if(res[i].name===fullname){StatusBar.set({type:'error',msg:'File already exists.',time:5000});return false;}}
return true;};this.set('archivePanel',panel);}
if(Lang.isObject(o)){panel.cfg.setProperty('postdata',o.postdata);}
panel.form.elements[0].value='';panel.form.action=this.M_BASE('archive',{p:this.get('currentFolder')});return panel;},archiveFiles:function(recs){this.getArchivePanel({postdata:function(){var a=[];for(var i=0,len=recs.length;i<len;i++){a[a.length]='file='+encodeURIComponent(recs[i].getData('path'));}
return a.join('&');}()}).show();},getVersionPanel:function(o){o=o||{};var panel=this.get('versionPanel'),oSelf=this;if(!panel){panel=new YAHOO.widget.Dialog('versionPanel',{buttons:[{text:'Delete',handler:function(){panel.form.action=oSelf.M_BASE('deleteversion');this.submit();}},{text:'Download',handler:function(){if(this.getData().v){window.open(oSelf.M_BASE('downloadversion',{file:this.getData().file,v:this.getData().v}));}else{StatusBar.set({type:'error',msg:'No version selected.',time:5000});}}},{text:'Restore',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.cancel();}}],visible:false,close:true,width:'500px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();panel.validate=function(){if(this.getData().v){return true;}else{StatusBar.set({type:'error',msg:'No version selected.',time:5000});return false;}};Dom.setStyle(panel.innerElement,'display','');this.set('versionPanel',panel);}
if(Lang.isObject(o)){var el=Dom.getElementBy(function(el){return Dom.hasClass(el,'versions');},'div',panel.form);el.innerHTML=o.body;panel.form.action=this.M_BASE('restoreversion');panel.form.file.value=o.file
panel.callback=o.callback;}
return panel;},showVersions:function(r){var oSelf=this;var body='<table class="app"><tr><th>Filename</th><th>Date</th><th>Select</th></tr>';var v=r.getData('versions'),name=r.getData('name');if(Lang.isArray(v)){for(var i=0,len=v.length;i<len;i++){var sDate=YAHOO.util.Date.format(new Date(v[i].ctime),{format:this.get('fullDateFormat')});body=body+'<tr><td>'+name+'</td><td>'+sDate+'</td><td><input type="radio" name="v" value="'+v[i].key+'" /></td></tr>';}}
body=body+'</table>';var p=this.getVersionPanel({file:r.getData('path'),callback:{success:function(o){oSelf.reloadFileTable(true);}},body:body});p.show();},getCopyMovePanel:function(o){o=o||{};var panel=this.get('copyMovePanel');if(!panel){panel=new YAHOO.widget.Dialog('copyMovePanel',{buttons:[{text:'Ok',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.cancel();}}],visible:false,close:true,width:'400px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();Dom.setStyle(panel.innerElement,'display','');this.set('copyMovePanel',panel);}
if(Lang.isObject(o)){panel.validate=o.validate||function(){return true;};panel.callback=o.callback;panel.form.action=this.M_BASE(o.cmd);panel.form.dest.value='';panel.setHeader(o.title);panel.cfg.setProperty('postdata',o.postdata);Dom.get('copyMovePanel_msg').innerHTML=o.msg;}
return panel;},getConfirmPanel:function(o){o=o||{};var panel=this.get('confirmPanel');if(!panel){panel=new YAHOO.widget.SimpleDialog('confirmPanel',{visible:false,close:true,width:'300px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none',icon:YAHOO.widget.SimpleDialog.ICON_WARN});panel.render();Dom.setStyle(panel.innerElement,'display','');this.set('confirmPanel',panel);}
if(Lang.isObject(o)){panel.setHeader(o.title);panel.cfg.setProperty('text',o.msg);panel.cfg.setProperty('buttons',[{text:'Delete',handler:o.handler},{text:'Cancel',handler:function(){this.hide();},isDefault:true}]);}
return panel;},getPermissionPanel:function(o){o=o||{};var panel=this.get('permissionPanel');if(!panel){panel=new YAHOO.widget.Dialog('permissionPanel',{buttons:[{text:'Change',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.hide();}}],visible:false,close:true,width:'340px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();Dom.setStyle(panel.innerElement,'display','');panel.myFormElements={checkboxes:Dom.getElementsBy(function(el){return el.type==='checkbox'},'input',panel.form),mode_n:Dom.getElementBy(function(el){return(el.type==='text'&&el.name==='mode_n')},'input',panel.form)};Event.on(panel.myFormElements.checkboxes,'click',function(){var perm=0;for(var i=0,len=panel.myFormElements.checkboxes.length;i<len;i++){if(panel.myFormElements.checkboxes[i].checked){perm=perm+parseInt(panel.myFormElements.checkboxes[i].value,10);}}
perm=perm+'';if(perm.length<3){for(var i=0;i<perm.length-3;i++){perm='0'+perm;}}
panel.myFormElements.mode_n.value=perm;});var setCheckboxes=function(){this.value=this.value.replace(/[^0-7]/g,'');var perm=parseInt(this.value,10)||0;if(perm<1){Dom.batch(panel.myFormElements.checkboxes,function(el){el.checked=false;});return;}
for(var i=0,len=panel.myFormElements.checkboxes.length;i<len;i++){var c=panel.myFormElements.checkboxes[i];c.checked=false;if((perm%parseInt(c.value,10))!==perm){c.checked=true;}
perm=perm%parseInt(c.value,10);}};Event.on(panel.myFormElements.mode_n,'keyup',setCheckboxes);panel.showEvent.subscribe(function(){this.myFormElements.mode_n.value=panel.perms||'000';setCheckboxes.call(this.myFormElements.mode_n);});this.set('permissionPanel',panel);}
if(o){panel.cfg.setProperty('postdata',o.postdata);panel.callback=o.callback;panel.perms=o.perms;panel.form.action=this.M_BASE('chmod');}
return panel;},createFolder:function(){this.getCreateFolderPanel().show();},deleteFolder:function(){var oSelf=this,p=this.getConfirmPanel({title:'Delete Directory',msg:'Delete selected directory?',handler:function(){Connect.asyncRequest('GET',oSelf.M_BASE('deldir',{p:oSelf.get('currentFolder')}),{success:function(o){oSelf.refreshFolderView();p.hide();}});}});p.show();},refreshFolderView:function(){var root=this.get('rootFolder'),current=(root.length>0?this.get('currentFolder').substr(root.length+1):this.get('currentFolder')),parts=current.split('/'),node=treeview.getRoot().children[0],dir=parts.shift(),interval;var expander=function(){interval.count=interval.count+1||1;if(interval.count>30){interval.cancel();interval=null;return;}
if(interval&&node.childrenRendered&&node.dynamicLoadComplete&&!node.isLoading){interval.cancel();interval=null;for(var i=0,len=node.children.length;i<len;i++){var child=node.children[i];if(child.label===dir){node=child;dir=parts.shift();node.expand();if(dir){interval=Lang.later(200,null,expander,null,true);}
break;}}}};treeview.removeChildren(node);node.expand();if(dir){interval=Lang.later(200,null,expander,null,true);}},uploadFile:function(){var panel=this.get('uploadPanel'),oSelf=this,fileIdHash={};if(!this._DS){this._DS=new YAHOO.util.LocalDataSource([],{responseType:YAHOO.util.LocalDataSource.TYPE_JSARRAY,responseSchema:{fields:['id','name','created','modified','type','size','progress','exists']}});}
if(!this._DT){this._DT=new YAHOO.widget.DataTable('uploadFileList',[{key:'name',label:'Filename',width:334,formatter:function(el,r,c,d){if(r.getData('exists')){el.innerHTML='<span style="color:#ff0000">'+d+'</span>';el.title='A file with this name already exists, and will be overwritten with this file.';}else{el.innerHTML=d;}}},{key:'size',label:'Size',width:80,formatter:function(el,r,c,d){el.innerHTML=byteHumanize(d);}},{key:'progress',label:'Progress',width:100}],oSelf._DS);}
if(!panel){panel=new YAHOO.widget.SimpleDialog('uploadPanel',{buttons:[{text:'Browse'},{text:'Upload',handler:function(){var len=oSelf.get('selectedUploadFiles').length;if(len<=0){return;}
var uploader=oSelf.get('uploader');if(uploader){uploader.setSimUploadLimit(len<2?len:2);var args={cmd:'upload',p:oSelf.get('currentFolder'),CookieStr:document.cookie};if(oSelf.get('currentConnection')){args.conn=oSelf.get('currentConnection');}
uploader.uploadAll('/controlpanel/FileManager/m.cmp','GET',args,'file');}}}],width:'600px',modal:true,constraintoviewport:true,fixedcenter:true,close:true,visible:false,draggable:true,underlay:'none'});panel.render();if(YAHOO.env.ua.gecko&&!YAHOO.env.ua.mac){panel.showEvent.subscribe(function(){Dom.removeClass('file_tble','yui-dt-scrollable');});panel.hideEvent.subscribe(function(){Dom.addClass('file_tble','yui-dt-scrollable');});}
panel.hideEvent.subscribe(function(){if(oSelf.get('uploader')){oSelf.get('uploader').destroy();oSelf.set('uploader',undefined);}});panel.showEvent.subscribe(function(){oSelf.set('selectedUploadFiles',[]);});Dom.setStyle(panel.innerElement,'display','');this.set('uploadPanel',panel);this.on('selectedUploadFilesChange',function(o){var b=panel.getButtons()[1];b.set('disabled',false);if(o.newValue.length<1){var upper=this.get('uploader');if(upper&&upper.clearFileList){upper.clearFileList();}
b.set('disabled',true);}
this._DS.liveData=o.newValue;this._DS.sendRequest(null,{success:this._DT.onDataReturnInitializeTable,failure:this._DT.onDataReturnInitializeTable,scope:this._DT});});}
panel.show();this.initUploader();},initUploader:function(){var oSelf=this,uploader=this.get('uploader'),panel=this.get('uploadPanel'),fileIdHash={};if(!uploader){var overlay=Dom.get('uploadCont'),button=panel.getButtons()[0];if(!overlay){overlay=document.createElement('div');overlay.id='uploadCont';Dom.setStyle(overlay,'position','absolute');var uiLayer=Dom.getRegion(button.get('element'));Dom.setStyle(overlay,'width',(uiLayer.right-uiLayer.left+6)+'px');Dom.setStyle(overlay,'height',(uiLayer.bottom-uiLayer.top)+'px');Dom.setStyle(button.get('element').parentNode,'float','right');Dom.setStyle(button.get('element').parentNode.parentNode,'height','2em');button.get('element').parentNode.insertBefore(overlay,button.get('element'));}
var init=function(){if(!this._swf.setFileFilters){this.destroy();oSelf.set('uploader',null);oSelf.initUploader();return;}
var ff=[{description:'All Supported Types',extensions:[]}];for(var k in fileFilters){var ext='*.'+fileFilters[k].join(';*.');ff[0].extensions[ff[0].extensions.length]=ext;ff[ff.length]={description:k,extensions:ext};}
ff[0].extensions=ff[0].extensions.join(';');this.setFileFilters(ff);this.setAllowMultipleFiles(true);};window['yuigen'+YAHOO.env._id_counter]={};uploader=new YAHOO.widget.Uploader(overlay);uploader.on('contentReady',init);uploader.on('uploadProgress',function(e){var n=fileIdHash[e.id];var prog=Math.round(100*(e.bytesLoaded/e.bytesTotal));oSelf._DT.updateCell(oSelf._DT.getRecord(n),'progress','<div style="height:5px;width:100px;background-color:#ccc;"><div style="height:5px;background-color:#f00;width:'+prog+'px;"></div></div>');});uploader.on('uploadComplete',function(e){var n=fileIdHash[e.id];var list=oSelf.get('selectedUploadFiles');e.bytesLoaded=list[n].size;e.bytesTotal=list[n].size;uploader.fireEvent('uploadProgress',e);delete fileIdHash[e.id];var isEmpty=true;for(var k in fileIdHash){if(Lang.hasOwnProperty(fileIdHash,k)){isEmpty=false;}}
if(isEmpty){oSelf.reloadFileTable(true);oSelf.set('selectedUploadFiles',[]);uploader.clearFileList();StatusBar.set({type:'success',msg:'Upload Complete.'});panel.hide();}});uploader.on('fileSelect',function(e){var arr=[],i=0,resp=oSelf.get('currentResponse'),fileIndex={};for(var j=0,len=resp.results.length;j<len;j++){fileIndex[resp.results[j].name]=true;}
for(var k in e.fileList){var entry=e.fileList[k];if(fileIndex[entry.name]){entry.exists=true;}else{entry.exists=false;}
arr.push(Lang.merge(entry,{progress:'<div style="height:5px;width:100px;background-color:#ccc;"></div>'}));fileIdHash[k]=i++;}
oSelf.set('selectedUploadFiles',arr);});uploader.on('mouseDown',function(){button.addStateCSSClasses('down');});uploader.on('mouseUp',function(){button.removeStateCSSClasses('down');});uploader.on('rollOver',function(){button.addStateCSSClasses('hover');});uploader.on('rollOut',function(){button.removeStateCSSClasses('hover');});this.set('uploader',uploader);}
return uploader;},createFile:function(){this.getCreateFilePanel().show();},moveFiles:function(recs){var files=[],hasFolders=false;for(var i=0,len=recs.length;i<len;i++){files[i]='file='+encodeURIComponent(recs[i].getData('path'));if(!hasFolders&&recs[i].getData('is_folder')){hasFolders=true;}}
var uri=files.join('&');var oSelf=this,p=this.getCopyMovePanel({title:'Move Items',msg:'Destination directory for selected item(s)',cmd:'movefiles',postdata:uri,callback:{success:function(){oSelf.set('bulkButtonsDisabled',true);oSelf.reloadFileTable(true);if(hasFolders){oSelf.refreshFolderView();}}}});p.getButtons()[0].set('label','Move');p.show();},copyFiles:function(recs){var files=[],hasFolders=false;for(var i=0,len=recs.length;i<len;i++){files[i]='file='+encodeURIComponent(recs[i].getData('path'));if(!hasFolders&&recs[i].getData('is_folder')){hasFolder=true;}}
var uri=files.join('&');var oSelf=this,p=this.getCopyMovePanel({title:'Copy Items',msg:'Destination directory for selected item(s)',cmd:'copyfiles',postdata:uri,callback:{success:function(){oSelf.set('bulkButtonsDisabled',true);oSelf.reloadFileTable(true);if(hasFolders){oSelf.refreshFolderView();}}}});p.getButtons()[0].set('label','Copy');p.show();},changeFilePermissions:function(recs){var files=[],perms=[0,0,0];for(var i=0,len=recs.length;i<len;i++){files[i]='file='+encodeURIComponent(recs[i].getData('path'));var p=recs[i].getData('mode_n').toString().split('');for(var j=0;j<perms.length;j++){perms[j]=+(parseInt(perms[j])|parseInt(p[j])).toString(8);}}
var oSelf=this,p=this.getPermissionPanel({postdata:files.join('&'),perms:parseInt(perms.join(''),10),callback:{success:function(o){oSelf.reloadFileTable(true);}}});p.show();},changeFolderPermissions:function(node){if(!node){node=treeview.getNodeByProperty('path',this.get('currentFolder'));}
var oSelf=this,p=this.getPermissionPanel({postdata:'file='+encodeURIComponent(node.data.path),perms:node.data.mode_n,callback:{success:function(o){oSelf.refreshFolderView();xhrdatasource.flushCache();}}});p.show();},deleteFiles:function(recs){var oSelf=this,p=this.getConfirmPanel({title:'Delete Items',msg:'Delete selected item(s)?',handler:function(){var files=[],hasFolders=true;for(var i=0,len=recs.length;i<len;i++){files[i]='file='+encodeURIComponent(recs[i].getData('path'));if(!hasFolders&&recs[i].getData('is_folder')){hasFolders=true;}}
var uri=files.join('&');Connect.asyncRequest('POST',oSelf.M_BASE('delfile'),{success:function(o){oSelf.set('bulkButtonsDisabled',true);oSelf.reloadFileTable(true);if(hasFolders){oSelf.refreshFolderView();}
p.hide();}},uri);}});p.show();},simpleEdit:function(record){var oSelf=this,panel=this.get('simpleEditPanel');if(!panel){panel=new YAHOO.widget.Dialog('simpleEditPanel',{buttons:[{text:'Save',handler:function(){this.submit();},isDefault:true},{text:'Cancel',handler:function(){this.cancel();}}],visible:false,close:true,width:'700px',modal:true,constraintoviewport:true,fixedcenter:true,underlay:'none'});panel.render();panel.callback={success:function(o){oSelf.reloadFileTable(true);}};Dom.setStyle(panel.innerElement,'display','');this.set('simpleEditPanel',panel);}
panel.form.action=this.M_BASE('savefile',{p:record.getData('path')});Connect.asyncRequest('GET',this.M_BASE('getfile',{p:record.getData('path')}),{success:function(o){panel.form.file_content.value=o.responseText;panel.show();}});},richEdit:function(record){var oSelf=this,panel=this.get('richEditPanel');if(!panel){var save=function(){var ed=tinyMCE.get('richEditContent');ed.setProgressState(1);if(ed.isHidden()){ed.show();}
ed.save();Connect.asyncRequest('POST',oSelf.M_BASE('savefile',{p:this.cfg.getProperty('postdata')}),{success:function(o){oSelf.reloadFileTable(true);ed.setProgressState(0);panel.hide();}},'file_content='+encodeURIComponent(ed.getContent()));},toggle=function(){tinyMCE.execCommand('mceToggleEditor',false,'richEditContent');};panel=new YAHOO.widget.SimpleDialog('richEditPanel',{buttons:[{text:'Toggle HTML Editor',handler:toggle},{text:'Save',handler:save,isDefault:true},{text:'Cancel',handler:function(){this.hide();}}],visible:false,close:true,modal:true,constraintoviewport:true,context:[document.body,'tl','tl','beforeShow'],underlay:'none'});panel.hideEvent.subscribe(function(){var ed=tinyMCE.get('richEditContent');if(ed){ed.remove();ed.destroy();}});panel.render();Dom.setStyle(panel.innerElement,'display','');this.set('richEditPanel',panel);}
panel.cfg.setProperty('postdata',record.getData('path'));Connect.asyncRequest('GET',this.M_BASE('getfile',{p:record.getData('path')}),{success:function(o){tinymce_config.document_base_url=o.getResponseHeader['X-BaseURI'];var ed=new tinymce.Editor('richEditContent',tinymce_config,tinymce.EditorManager);ed.on('init',function(){ed.setContent(o.responseText);panel.cfg.setProperty('width','900px');panel.cfg.setProperty('height','780px');panel.show();});ed.render();}});},showModeColumn:function(){var col=datatable.getColumn('mode_n');if(col.hidden){datatable.showColumn(col);this.set('fileTableColumnOffset',this.get('fileTableColumnOffset')+col.width+20);}},hideModeColumn:function(){var col=datatable.getColumn('mode_n');if(!col.hidden){datatable.hideColumn(col);this.set('fileTableColumnOffset',this.get('fileTableColumnOffset')-col.width-20);}},toggleModeColumn:function(bState){var col=datatable.getColumn('mode_n');bState=Lang.isBoolean(bState)?bState:col.hidden;if(bState){this.showModeColumn();}else{this.hideModeColumn();}}});})();
